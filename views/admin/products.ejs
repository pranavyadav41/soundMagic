<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Modernize Free</title>
  <link rel="shortcut icon" type="image/png" href="../assets/images/logos/favicon.png" />
  
    <!-- Google Font -->
    <link href="https://fonts.googleapis.com/css2?family=Nunito+Sans:wght@300;400;600;700;800;900&display=swap"
    rel="stylesheet">

  <link rel="stylesheet" href="../assets/css/styles.min.css" />
  <link rel="stylesheet" href="/adminCss/products.css" />
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2"></script>
  <style>
       .coupon-container {
            text-align: center;
            padding: 20px;
        }

        .coupon {
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            padding: 15px;
            margin: 10px;
            border-radius: 5px;
            display: flex;
            flex-direction: column;
            max-width: 400px;
            text-align: left;
        }

        .coupon strong {
            color: #333;
        }
        .card {
          margin: 20px;
        }
  </style>
 
 
</head>

<body>
   <!--  Body Wrapper -->
   <div class="page-wrapper" id="main-wrapper" data-layout="vertical" data-navbarbg="skin6" data-sidebartype="full"
   data-sidebar-position="fixed" data-header-position="fixed">
   <!-- Sidebar Start -->
   <aside class="left-sidebar">
     <!-- Sidebar scroll-->
     <div>
       <div class="brand-logo d-flex align-items-center justify-content-between">
         <a href="./index.html" class="text-nowrap logo-img">
           <img src="/assets/images/logos/download.png" width="180" alt="" />
         </a>
         <div class="close-btn d-xl-none d-block sidebartoggler cursor-pointer" id="sidebarCollapse">
           <i class="ti ti-x fs-8"></i>
         </div>
       </div>
            <!-- Sidebar navigation-->
            <nav class="sidebar-nav scroll-sidebar" data-simplebar="">
              <ul id="sidebarnav">
                <li class="nav-small-cap">
                  <i class="ti ti-dots nav-small-cap-icon fs-4"></i>
                  <span class="hide-menu">Home</span>
                </li>
                <li class="sidebar-item">
                  <a class="sidebar-link" href="/admin/dashboard" aria-expanded="false">
                    <span>
                      <i class="ti ti-layout-dashboard"></i>
                    </span>
                    <span class="hide-menu">Dashboard</span>
                  </a>
                </li>
                <li class="sidebar-item">
                  <a class="sidebar-link" href="/admin/users" aria-expanded="false">
                    <span>
                      <i class="ti ti-article"></i>
                    </span>
                    <span class="hide-menu">Customers</span>
                  </a>
                </li>
                <li class="sidebar-item">
                  <a class="sidebar-link" href="/admin/categories" aria-expanded="false">
                    <span>
                      <i class="ti ti-alert-circle"></i>
                    </span>
                    <span class="hide-menu">Categories</span>
                  </a>
                </li>
                <li class="sidebar-item">
                  <a class="sidebar-link" href="/admin/products" aria-expanded="false">
                    <span>
                      <i class="ti ti-cards"></i>
                    </span>
                    <span class="hide-menu">Products</span>
                  </a>
                </li>
                <li class="sidebar-item">
                  <a class="sidebar-link" href="/admin/orders" aria-expanded="false">
                    <span>
                      <i class="ti ti-file-description"></i>
                    </span>
                    <span class="hide-menu">Orders</span>
                  </a>
                </li>
                <li class="sidebar-item">
                  <a class="sidebar-link" href="/admin/returnOrders" aria-expanded="false">
                    <span>
                      <i class="ti ti-file-description"></i>
                    </span>
                    <span class="hide-menu">Returned Orders</span>
                  </a>
                </li>
                <li class="sidebar-item">
                  <a class="sidebar-link" href="/admin/coupons" aria-expanded="false">
                    <span>
                      <i class="ti ti-typography"></i>
                    </span>
                    <span class="hide-menu">Coupons</span>
                  </a>
                </li>
                <li class="sidebar-item">
                  <a class="sidebar-link" href="/admin/offers" aria-expanded="false">
                    <span>
                      <i class="ti ti-typography"></i>
                    </span>
                    <span class="hide-menu">Offers</span>
                  </a>
                </li>
                <li class="sidebar-item">
                  <a class="sidebar-link" href="/admin/banner" aria-expanded="false">
                    <span>
                      <i class="ti ti-login"></i>
                    </span>
                    <span class="hide-menu">Banners</span>
                  </a>
                </li>
                <li class="sidebar-item">
                  <a class="sidebar-link" href="/admin/logout" aria-expanded="false">
                    <span>
                      <i class="ti ti-login"></i>
                    </span>
                    <span class="hide-menu">Logout</span>
                  </a>
                </li>
              </ul>
            </nav>
            <!-- End Sidebar navigation -->
     </div>
     <!-- End Sidebar scroll-->
   </aside>
   <!--  Sidebar End -->
   <!--  Main wrapper -->
   <div class="body-wrapper">
     <!--  Header Start -->
     <header class="app-header">
       <nav class="navbar navbar-expand-lg navbar-light">
         <ul class="navbar-nav">
           <li class="nav-item d-block d-xl-none">
             <a class="nav-link sidebartoggler nav-icon-hover" id="headerCollapse" href="javascript:void(0)">
               <i class="ti ti-menu-2"></i>
             </a>
           </li>
           <li class="nav-item">
             <a class="nav-link nav-icon-hover" href="javascript:void(0)">
               <i class="ti ti-bell-ringing"></i>
               <div class="notification bg-primary rounded-circle"></div>
             </a>
           </li>
         </ul>
         <div class="navbar-collapse justify-content-end px-0" id="navbarNav">
           <ul class="navbar-nav flex-row ms-auto align-items-center justify-content-end">
             <a href="https://adminmart.com/product/modernize-free-bootstrap-admin-dashboard/" target="_blank" class="btn btn-primary">Download Free</a>
             <li class="nav-item dropdown">
               <a class="nav-link nav-icon-hover" href="javascript:void(0)" id="drop2" data-bs-toggle="dropdown"
                 aria-expanded="false">
                 <img src="../assets/images/profile/user-1.jpg" alt="" width="35" height="35" class="rounded-circle">
               </a>
               <div class="dropdown-menu dropdown-menu-end dropdown-menu-animate-up" aria-labelledby="drop2">
                 <div class="message-body">
                   <a href="javascript:void(0)" class="d-flex align-items-center gap-2 dropdown-item">
                     <i class="ti ti-user fs-6"></i>
                     <p class="mb-0 fs-3">My Profile</p>
                   </a>
                   <a href="javascript:void(0)" class="d-flex align-items-center gap-2 dropdown-item">
                     <i class="ti ti-mail fs-6"></i>
                     <p class="mb-0 fs-3">My Account</p>
                   </a>
                   <a href="javascript:void(0)" class="d-flex align-items-center gap-2 dropdown-item">
                     <i class="ti ti-list-check fs-6"></i>
                     <p class="mb-0 fs-3">My Task</p>
                   </a>
                   <a href="./authentication-login.html" class="btn btn-outline-primary mx-3 mt-2 d-block">Logout</a>
                 </div>
               </div>
             </li>
           </ul>
         </div>
       </nav>
     </header>
      <!-- //User Details Page -->
      <header>
        <h1>Product Details</h1>
    </header>

    <div class="container">
      <div class="search-container">
        <form>
        <input type="text" class="search-input" name="search" placeholder="Search Product">
        <button class="search-button" type="submit">Search</button>
      </form>
        <form action="/admin/products/add-product">
          <button type="submit" class="add-button">Add Product</button>
        </form>
      </div>
  
      <div class="table-responsive">
        <table>
          <thead>
            <tr>
              <th>Image</th>
              <th>Product Name</th>
              <th>Price</th>
              <th>Offer Price</th> 
              <th>Description</th>
              <th>Stock</th>
              <th>Category</th>
              <th>Action</th>
            </tr>
          </thead> 
          <tbody>
            <% products.forEach((product, index) => { %>
              <tr>
                <td>
                  <% product.image.forEach((imagePath, index) => { %>
                    <img src="/productImages/<%= imagePath %>" alt="Product Image" width="50">
                  <% }); %>
                  <% if(product.productOffer.offerApplied==true){ %>
                  <div class="selected-offer mt-2">OFFER:<%= product.productOffer.offerName%></div>
                  <button class="btn btn btn-sm" onclick="removeOffer('<%= product._id %>')" style="background-color: red; color:white;">remove</button>
                  <% } %>
                </td>
                <td><%= product.productName %></td>
                <td>â‚¹<%= product.offerPrice %></td>
                <% if(product.productOffer.offerApplied==true || product.categoryOffer.offerApplied==true){ %>
                <td>&#8377;<%= product.totalOfferPrice %></td>
                <% }else{ %>

                  <td>None</td>


                  <% } %>
                <td><%= product.description %></td> 
                <td><%= product.stock %></td>
                <td><%= product.category.name %></td>
                <td>
                  <div class="action-buttons">
                    <form action="products/edit/<%= product._id %>" method="GET">
                    <button class="action-button">Edit</button>
                    </form>
                    <button class="unlist-button" data-product-id ="<%= product._id %>" data-state="<%= product.is_listed ? 'true' : 'false' %>" ><%= product.is_listed ? 'Unlist' : 'List' %></button>
                    <button  class="btn btn-dark" onclick="applyOffer('<%= product._id %>')"  data-toggle="modal" data-target="#exampleModalCenter" >Apply Offer</button>
                  </div>
                </td>
              </tr>
            <% }); %>
          </tbody>
        </table>
      </div><br>
      <nav aria-label="Page navigation example">
        <ul class="pagination">
          <% previous = (currentPage > 1) ? currentPage - 1 : 1;
          next = (currentPage < totalPages) ? currentPage + 1 : totalPages; %>

          <li class="page-item"><a class="page-link" href="?page=<%= previous %>">previous</a></li>
          <% for(let j=1;j<=totalPages;j++){ %>
          <li class="page-item"><a class="page-link" href="?page=<%= j %>"><%= j %></a></li>
          <% } %>
          <li class="page-item"><a class="page-link" href="?page=<%= next %>">next</a></li>
        </ul>

      </nav> 
    </div> 

    
  
    
  <script src="/adminScript/products.js"></script>
  <script src="/assets/libs/jquery/dist/jquery.min.js"></script>
  <script src="/assets/libs/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/assets/js/sidebarmenu.js"></script>
  <script src="/assets/js/app.min.js"></script>
  <script src="/assets/libs/simplebar/dist/simplebar.js"></script>
  <script>


  function applyOffer(productId){
  console.log(productId); 
      const html = `  
                    <% offers.forEach((offer)=>{ %>
                      <% if(new Date(offer.expiry) >= new Date()){ %>
                    <div class="coupon">
                        <p><strong><%= offer.offerName %></strong></p>
                        <p><%= offer.discountPercentage  %>%<span>Discount</span></p>
                        <button class="btn btn-dark btn-sm" onclick="selectOffer('${productId}','<%= offer._id %>')">APPLY</button>
                    </div>
                    <% } %>
                    <% }) %>
                   `
            // Show a SweetAlert when the checkbox is checked
            Swal.fire({
  html:html,
  showCloseButton: true,
  showConfirmButton: false

});


 
    }

    function selectOffer(productId,offerId) {
    fetch('/admin/addProductOffer',{
      method:"POST",
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({productId,offerId})
    }) .then(response=>response.json())
                   .then(data=>{
                   if(data.success){
                    Swal.fire({
                    icon: "success",
                    title: "Offer added",
                    showConfirmButton: false, 
                    timer: 1500
});
setTimeout(function(){
  location.reload()},1500)
                   }else {
            // Handle error case
            console.error('Error:', data.error);
            Swal.fire({
                icon: "error",
                title: "Error",
                text: data.error,
                showConfirmButton: false,
                timer:1500
            });
           
        }
                    })
  }

  function removeOffer(productId){
    fetch('/admin/removeProductOffer',{
      method:"POST",
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({productId})
    }) .then(response=>response.json())
                   .then(data=>{
                   if(data.success){
                    Swal.fire({
                    icon: "success",
                    title: "Offer removed",
                    showConfirmButton: false, 
                    timer: 1500
});
setTimeout(function(){
  location.reload()},1500)
                   }else {
            // Handle error case
            console.error('Error:', data.error);
            Swal.fire({
                icon: "error",
                title: "Error",
                text: data.error,
                showConfirmButton: false,
                timer:1500
            });
        }
                    })
  }
  </script>
</body>

</html>